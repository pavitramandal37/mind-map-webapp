{% extends "base.html" %}

{% block title %}Dashboard - Mind Map App{% endblock %}

{% block head %}
<style>
    /* Custom Tooltip Styling */
    .map-card[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: -45px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, rgba(127, 156, 245, 0.95), rgba(127, 156, 245, 0.85));
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        white-space: nowrap;
        box-shadow: 0 4px 12px rgba(127, 156, 245, 0.3), 0 2px 6px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        pointer-events: none;
        animation: tooltipFadeIn 0.3s ease-out;
        letter-spacing: 0.3px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    /* Tooltip Arrow */
    .map-card[title]:hover::before {
        content: '';
        position: absolute;
        bottom: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-bottom: 8px solid rgba(127, 156, 245, 0.95);
        z-index: 1001;
        pointer-events: none;
        animation: tooltipFadeIn 0.3s ease-out;
    }

    @keyframes tooltipFadeIn {
        from {
            opacity: 0;
            transform: translateX(-50%) translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    }

    /* Ensure tooltip doesn't overflow on small screens */
    @media (max-width: 768px) {
        .map-card[title]:hover::after {
            font-size: 12px;
            padding: 8px 12px;
        }
    }
</style>
{% endblock %}

{% block content %}
<nav class="navbar">
    <div class="container">
        <div class="logo">MindMap</div>
        <div class="nav-links">
            <a href="#" onclick="logout()">Logout</a>
        </div>
    </div>
</nav>

<div class="container">

    <!-- Hero Section with Quote -->
    <div class="hero-section">
        <div class="hero-banner">
            <img src="/static/assets/Homepage_banner.jpg" alt="Mind Map Banner" class="hero-image">
            <div class="hero-overlay">
                <div class="hero-content">
                    <h1 class="hero-quote">Crafted for educational exploration</h1>
                    <p class="hero-author">‚Äî by Pavitra Mandal</p>
                </div>
            </div>
        </div>
    </div>

    <!-- How to Use Section -->
    <div class="glass how-to-use">
        <h2>Unlock Your Creativity</h2>
        <p style="color: var(--text-muted);">Visualize your ideas in seconds.</p>
        <div class="steps-container">
            <div class="step-card glass" onclick="scrollToMaps()" style="cursor: pointer;">
                <div class="step-icon">üí°</div>
                <h3>Create</h3>
                <p>Start with a central idea</p>
            </div>
            <div class="step-card glass" onclick="scrollToMaps()" style="cursor: pointer;">
                <div class="step-icon" style="animation-delay: 0.2s">üåø</div>
                <h3>Branch Out</h3>
                <p>Add child nodes instantly</p>
            </div>
            <div class="step-card glass" onclick="scrollToMaps()" style="cursor: pointer;">
                <div class="step-icon" style="animation-delay: 0.4s">‚ú®</div>
                <h3>Customize</h3>
                <p>Edit and organize freely</p>
            </div>
        </div>
    </div>

    <div class="dashboard-header">
        <h2>My Mind Maps</h2>
    </div>

    <div class="map-grid" id="mapGrid">
        <!-- Maps will be loaded here -->
        <div class="map-card add-map-card" onclick="createNewMap()">
            +
        </div>
    </div>
</div>

<!-- Edit Title Modal -->
<div id="editTitleModal" class="modal">
    <div class="modal-content glass">
        <span class="modal-close" onclick="closeEditModal()">&times;</span>
        <h3>Edit Title</h3>
        <div class="form-group">
            <input type="text" id="newMapTitle" class="form-control" placeholder="Enter new title">
        </div>
        <button class="btn btn-primary" onclick="submitEditTitle()">Save Changes</button>
    </div>
</div>

<!-- Create Map Modal -->
<div id="createMapModal" class="modal">
    <div class="modal-content glass">
        <span class="modal-close" onclick="closeCreateModal()">&times;</span>
        <h3>Create New Mind Map</h3>
        <div class="form-group">
            <input type="text" id="createMapTitle" class="form-control" placeholder="Enter map title...">
        </div>
        <button class="btn btn-primary" onclick="submitCreateMap()">Create</button>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteConfirmModal" class="modal">
    <div class="modal-content glass" style="text-align: center; max-width: 400px;">
        <span class="modal-close" onclick="closeDeleteConfirmModal()">&times;</span>
        <h3 style="color: #e53e3e; margin-bottom: 15px;">‚ö†Ô∏è Delete Mind Map?</h3>
        <p style="margin-bottom: 25px; color: var(--text-muted);">
            Are you sure you want to delete this mind map? This action cannot be undone.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-secondary" onclick="closeDeleteConfirmModal()"
                style="width: auto; padding: 10px 25px;">
                Cancel
            </button>
            <button class="btn btn-primary" onclick="confirmDeleteMap()"
                style="width: auto; padding: 10px 25px; background: #e53e3e;">
                Delete
            </button>
        </div>
    </div>
</div>

<!-- Error Modal -->
<div id="errorModal" class="modal">
    <div class="modal-content glass" style="text-align: center;">
        <span class="modal-close" onclick="closeErrorModal()">&times;</span>
        <h3 style="color: #e53e3e; margin-bottom: 15px;">Error</h3>
        <p id="errorMessage" style="margin-bottom: 20px; color: var(--text-muted);">
            An error occurred.
        </p>
        <button class="btn btn-primary" onclick="closeErrorModal()" style="width: auto; padding: 10px 30px;">
            OK
        </button>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentEditMapId = null;

    function scrollToMaps() {
        const mapSection = document.getElementById('mapGrid');
        if (mapSection) {
            mapSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    async function loadMaps() {
        const token = getAuthToken();
        if (!token) {
            window.location.href = '/';
            return;
        }

        try {
            const response = await fetch('/api/maps/', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const maps = await response.json();
                const grid = document.getElementById('mapGrid');

                // Keep the add button
                const addBtn = grid.querySelector('.add-map-card');
                grid.innerHTML = '';

                maps.forEach(map => {
                    const card = document.createElement('div');
                    card.className = 'map-card glass';

                    // Card Content
                    card.innerHTML = `
                        <div onclick="window.location.href='/editor/${map.id}'" style="flex-grow: 1;">
                            <div class="map-title">${map.title}</div>
                            <div class="map-date">Created: ${new Date(map.created_at || Date.now()).toLocaleDateString()}</div>
                        </div>
                        <div class="map-actions">
                            <button class="action-btn" onclick="openEditModal(${map.id}, '${map.title}')">‚úèÔ∏è Rename</button>
                            <button class="action-btn" onclick="copyMap(${map.id})">üìã Copy</button>
                            <button class="action-btn" onclick="deleteMap(${map.id})">üóëÔ∏è Delete</button>
                        </div>
                    `;

                    // Set title attribute AFTER innerHTML to ensure it's not overwritten
                    card.title = 'Double tap to open mindmap';

                    grid.appendChild(card);
                });

                grid.appendChild(addBtn);
            } else if (response.status === 401) {
                logout();
            }
        } catch (error) {
            console.error('Error loading maps:', error);
        }
    }

    function createNewMap() {
        document.getElementById('createMapTitle').value = '';
        document.getElementById('createMapModal').style.display = 'flex';
        document.getElementById('createMapTitle').focus();
    }

    function closeCreateModal() {
        document.getElementById('createMapModal').style.display = 'none';
        document.getElementById('createMapTitle').value = '';
    }

    function openErrorModal(msg) {
        if (msg) document.getElementById('errorMessage').textContent = msg;
        document.getElementById('errorModal').style.display = 'flex';
    }

    function closeErrorModal() {
        document.getElementById('errorModal').style.display = 'none';
    }

    async function submitCreateMap() {
        const title = document.getElementById('createMapTitle').value;
        if (!title) {
            openErrorModal("Please enter a title for your mind map.");
            return;
        }

        const token = getAuthToken();
        try {
            const response = await fetch('/api/maps/', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title: title,
                    data: JSON.stringify({ name: title, children: [] })
                })
            });

            if (response.ok) {
                closeCreateModal();
                loadMaps();
            } else {
                openErrorModal('Failed to create map. Please try again.');
            }
        } catch (error) {
            console.error('Error creating map:', error);
        }
    }

    let deleteMapId = null;

    async function deleteMap(id) {
        deleteMapId = id;
        document.getElementById('deleteConfirmModal').style.display = 'flex';
    }

    function closeDeleteConfirmModal() {
        document.getElementById('deleteConfirmModal').style.display = 'none';
        deleteMapId = null;
    }

    async function confirmDeleteMap() {
        if (!deleteMapId) return;

        const token = getAuthToken();
        try {
            const response = await fetch(`/api/maps/${deleteMapId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                closeDeleteConfirmModal();
                loadMaps();
            } else {
                closeDeleteConfirmModal();
                openErrorModal('Failed to delete map. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting map:', error);
            closeDeleteConfirmModal();
            openErrorModal('An error occurred while deleting the map.');
        }
    }

    async function copyMap(id) {
        const token = getAuthToken();
        try {
            const response = await fetch(`/api/maps/${id}/copy`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                loadMaps();
            } else {
                openErrorModal('Failed to copy map. Please try again.');
            }
        } catch (error) {
            console.error('Error copying map:', error);
        }
    }

    function openEditModal(id, currentTitle) {
        currentEditMapId = id;
        document.getElementById('newMapTitle').value = currentTitle;
        document.getElementById('editTitleModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editTitleModal').style.display = 'none';
        currentEditMapId = null;
    }

    async function submitEditTitle() {
        if (!currentEditMapId) return;
        const newTitle = document.getElementById('newMapTitle').value;
        if (!newTitle) return;

        const token = getAuthToken();
        try {
            const response = await fetch(`/api/maps/${currentEditMapId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: newTitle })
            });

            if (response.ok) {
                closeEditModal();
                loadMaps();
            } else {
                openErrorModal('Failed to update title. Please try again.');
            }
        } catch (error) {
            console.error('Error updating title:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', loadMaps);
</script>
{% endblock %}